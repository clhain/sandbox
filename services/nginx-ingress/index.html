<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://clhain.github.io/sandbox/services/nginx-ingress/" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>NGINX Kubernetes Ingress - Sandbox Documentation</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "NGINX Kubernetes Ingress";
        var mkdocs_page_input_path = "services/nginx-ingress.md";
        var mkdocs_page_url = "/sandbox/services/nginx-ingress/";
      </script>
    
    <script src="../../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> Sandbox Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">Home</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Getting Started</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../installation/quick-start/">Quick Start</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../installation/getting-started/">Getting Started</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../installation/pre-reqs/">Common Pre-Reqs</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../installation/dns/">DNS Configuration</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../installation/byoc-helm/">Bring Your Own Cluster (Helm)</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../installation/byoc-argocd/">Bring Your Own Cluster (ArgoCD)</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../installation/all-in-one-gke/">All-In-One (GKE)</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Customization</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../customization/deploy-an-app/">Deploy Your App</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Sandbox Apps</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../argocd/">ArgoCD</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../cert-manager/">Cert Manager</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../gatekeeper/">OPA Gatekeeper</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../grafana/">Grafana</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../loki/">Loki</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="./">NGINX Kubernetes Ingress</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#quick-links">Quick Links</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#background">Background</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#sandbox-customizations">Sandbox Customizations</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#enable-a-virtual-server-ingress-for-a-service">Enable A Virtual Server / Ingress for A Service</a>
    </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../nginx-mesh/">NGINX Service Mesh</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../oauth-proxy/">Oauth2 Proxy</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../opentelemetry-operator/">Opentelemetry Operator</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../prometheus-operator/">Prometheus Operator</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../sealed-secrets/">Sealed Secrets</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../tempo/">Tempo</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Misc</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../troubleshooting/">Troubleshooting</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../faq/">Frequently Asked Questions</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">Sandbox Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" alt="Docs"></a> &raquo;</li>
          <li>Sandbox Apps &raquo;</li>
      <li>NGINX Kubernetes Ingress</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="sandbox-service-nginx-kubernetes-ingress-controller">Sandbox Service: NGINX Kubernetes Ingress Controller</h1>
<h2 id="quick-links">Quick Links</h2>
<ul>
<li><a href="https://docs.nginx.com/nginx-ingress-controller/">Project Site</a></li>
<li><a href="https://github.com/nginxinc/kubernetes-ingress">Github Repo</a></li>
<li><a href="https://github.com/nginxinc/kubernetes-ingress/tree/main/deployments/helm-chart">Helm Chart</a></li>
</ul>
<h2 id="background">Background</h2>
<p>NGINX Ingress (from NGINX INC), is the default container ingress for the Sandbox platform.
It's integrated automatically with the platform Observability tooling (metrics, logs, traces, dashboards),
Certificate Manager and Let's Encrypt for automated cert provisioning,
and contains reference patterns for integrating with Oauth2 Proxy for authenticated ingress enforcement.</p>
<p>The out of the box configs will run with either NGINX Ingress Open Source, or the NGINX Plus based version.</p>
<h2 id="sandbox-customizations">Sandbox Customizations</h2>
<p>The Sandbox installation of nginx ingress includes a mostly default installation with the following modifications:</p>
<ul>
<li>Enables a Grafana Dashboard config for automatic integration with the cluster Grafana</li>
<li>Enables Cert Manager integration</li>
<li>Enables health status endpoints</li>
<li>Enables various parameters like 8k buffer size and http2 for integration with other Sandbox Apps.</li>
<li>Enables opentracing and forwards spans to the Sandbox Opentelemetry Collector.</li>
<li>Adds custom logging config with extensive performance and other data attributes for each request.</li>
<li>Enables prometheus compatible scrape endpoint for metrics.</li>
</ul>
<p>Values can be passed to the official nginx-ingress chart (by adding them under the "nginx-ingress" key),
as shown on line 4 of the values file here:</p>
<pre><code class="language-yaml">enableIngressDashboard: true
enableAppProtectDashboard: false

nginx-ingress:
  controller:
    enableCertManager: true
    enableSnippets: true
    enablePreviewPolicies: true
    healthStatus: true
    nginxplus: false
    appprotect:
      enable: false
    config:
      name: nginx-config
      entries:
        # For oauth2 proxy azure integration
        proxy-buffer-size: &quot;8k&quot;
        # For GRPC support
        http2: &quot;true&quot;
        # Opentracing configs
        opentracing: &quot;true&quot;
        opentracing-tracer: /usr/local/lib/libjaegertracing_plugin.so
        location-snippets: &quot;opentracing_propagate_context;&quot;
        opentracing-tracer-config: '{&quot;service_name&quot;: &quot;nginx-ingress&quot;,&quot;diabled&quot;: false,&quot;propagation_format&quot;: &quot;w3c&quot;,&quot;reporter&quot;: {&quot;logSpans&quot;: true,&quot;endpoint&quot;: &quot;http://otc-collector.opentelemetry-operator.svc:14268/api/traces&quot;},&quot;sampler&quot;: {&quot;type&quot;: &quot;const&quot;,&quot;param&quot;: &quot;1&quot;}}'
        # Additional Logging config / format
        log-format-escape-json: &quot;true&quot;
        log-format: |
          {&quot;timestamp&quot;: &quot;$time_iso8601&quot;, &quot;host&quot;: &quot;$host&quot;, &quot;uri&quot;: &quot;$request_uri&quot;, &quot;upstreamStatus&quot;: &quot;$upstream_status&quot;, &quot;upstreamAddr&quot;: &quot;$upstream_addr&quot;,
          &quot;requestMethod&quot;: &quot;$request_method&quot;, &quot;requestUrl&quot;: &quot;$host$request_uri&quot;, &quot;status&quot;: $status, &quot;requestSize&quot;:
          &quot;$request_length&quot;, &quot;responseSize&quot;: &quot;$upstream_response_length&quot;, &quot;userAgent&quot;: &quot;$http_user_agent&quot;, &quot;xff&quot;: &quot;$http_x_forwarded_for&quot;, &quot;xfh&quot;: &quot;$http_x_forwarded_host&quot;, &quot;xfp&quot;: &quot;$http_x_forwarded_proto&quot;,
          &quot;remoteIp&quot;: &quot;$remote_addr&quot;, &quot;referer&quot;: &quot;$http_referer&quot;, &quot;latency&quot;: &quot;$upstream_response_time&quot;,
          &quot;protocol&quot;:&quot;$server_protocol&quot;, &quot;requestTime&quot;: &quot;$request_time&quot;, &quot;upstreamConnectTime&quot;: &quot;$upstream_connect_time&quot;,
          &quot;upstreamHeaderTime&quot;:&quot;$upstream_header_time&quot;, &quot;upstreamResponseTime&quot;: &quot;$upstream_response_time&quot;, &quot;traceParent&quot;: &quot;$opentracing_context_traceparent&quot;}
    service:
      annotations:
        networking.gke.io/internal-load-balancer-allow-global-access: &quot;true&quot;
      extraLabels:
        app: kic-nginx-ingress
  prometheus:
    create: true
    port: 9113
</code></pre>
<p>See <a href="../../customization/default-services/">Customizing Default Services</a> for more information on overriding default values.</p>
<h2 id="enable-a-virtual-server-ingress-for-a-service">Enable A Virtual Server / Ingress for A Service</h2>
<p>Virtual Servers can be enabled with Oauth2 Proxy integration (or without), through the NGINX Ingress custom resources.
This example enables ingress for the Grafana instance and passes authentication information from Oauth2 proxy. In this case,
the top level Virtual Server passes traffic to the individual Virtual Server Routes for Grafana and Oauth2 Proxy.</p>
<blockquote>
<p>Note: the "{{ .Values.clusterDomain }}" field is passed to the cluster via helm in a default install.</p>
</blockquote>
<pre><code class="language-yaml">apiVersion: k8s.nginx.org/v1
kind: VirtualServer
metadata:
  name: grafana
  namespace: &quot;grafana&quot;
spec:
  host: &quot;grafana.{{ .Values.clusterDomain }}&quot;
  tls:
    cert-manager:
      cluster-issuer: letsencrypt-prod
    secret: grafana-cert
  routes:
  - path: /
    route: grafana/grafana
    location-snippets: |
      auth_request /oauth2/auth;
      error_page 401 = https://auth.{{ .Values.clusterDomain }}/oauth2/start?rd=https://$host$uri;
      auth_request_set $user   $upstream_http_x_auth_request_user;
      auth_request_set $email  $upstream_http_x_auth_request_email;
      auth_request_set $auth_header $upstream_http_authorization;
      auth_request_set $token  $upstream_http_x_auth_request_access_token;
      proxy_set_header X-Access-Token $token;
      auth_request_set $auth_cookie $upstream_http_set_cookie;
      add_header Set-Cookie $auth_cookie;
      proxy_set_header X-Auth-Request-Email &quot;$email&quot;;
      proxy_set_header X-Auth-Request-User &quot;$user&quot;;
      #proxy_set_header Authorization &quot;$auth_header&quot;;
      set $session_id_header $upstream_http_x_auth_request_email;
  - path: /oauth2
    route: oauth-proxy/oauth-proxy-grafana

---
apiVersion: k8s.nginx.org/v1
kind: VirtualServerRoute
metadata:
  name: grafana
  namespace: grafana
spec:
  host: &quot;grafana.{{ .Values.clusterDomain }}&quot;
  upstreams:
  - name: grafana
    service: grafana
    port: 80
  subroutes:
  - path: /
    action:
      pass: grafana

---
apiVersion: k8s.nginx.org/v1
kind: VirtualServerRoute
metadata:
  name: oauth-proxy-grafana
  namespace: oauth-proxy
spec:
  host: &quot;grafana.{{ .Values.clusterDomain }}&quot;
  upstreams:
  - name: oauth2-proxy
    service: oauth-proxy-oauth2-proxy
    port: 80
  subroutes:
  - path: /oauth2/auth
    location-snippets: &quot;internal;&quot;
    action:
      pass: oauth2-proxy
</code></pre>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../loki/" class="btn btn-neutral float-left" title="Loki"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../nginx-mesh/" class="btn btn-neutral float-right" title="NGINX Service Mesh">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../loki/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../nginx-mesh/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme_extra.js" defer></script>
    <script src="../../js/theme.js" defer></script>
      <script src="../../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
