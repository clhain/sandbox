<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://clhain.github.io/sandbox/services/oauth-proxy/" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>Oauth2 Proxy - Sandbox Documentation</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Oauth2 Proxy";
        var mkdocs_page_input_path = "services/oauth-proxy.md";
        var mkdocs_page_url = "/sandbox/services/oauth-proxy/";
      </script>
    
    <script src="../../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> Sandbox Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">Home</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Getting Started</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../installation/quick-start/">Quick Start</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../installation/getting-started/">Getting Started</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../installation/pre-reqs/">Common Pre-Reqs</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../installation/dns/">DNS Configuration</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../installation/byoc-helm/">Bring Your Own Cluster (Helm)</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../installation/byoc-argocd/">Bring Your Own Cluster (ArgoCD)</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../installation/all-in-one-gke/">All-In-One (GKE)</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Customization</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../customization/deploy-an-app/">Deploy Your App</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Sandbox Apps</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../argocd/">ArgoCD</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../cert-manager/">Cert Manager</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../gatekeeper/">OPA Gatekeeper</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../grafana/">Grafana</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../loki/">Loki</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../nginx-ingress/">NGINX Kubernetes Ingress</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../nginx-mesh/">NGINX Service Mesh</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="./">Oauth2 Proxy</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#quick-links">Quick Links</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#background">Background</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#sandbox-customizations">Sandbox Customizations</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#enable-a-virtual-server-for-oauth-proxy-authentication">Enable A Virtual Server For Oauth Proxy Authentication</a>
    </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../opentelemetry-operator/">Opentelemetry Operator</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../prometheus-operator/">Prometheus Operator</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../sealed-secrets/">Sealed Secrets</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../tempo/">Tempo</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Misc</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../troubleshooting/">Troubleshooting</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../faq/">Frequently Asked Questions</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">Sandbox Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" alt="Docs"></a> &raquo;</li>
          <li>Sandbox Apps &raquo;</li>
      <li>Oauth2 Proxy</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="sandbox-service-oauth2-proxy">Sandbox Service: Oauth2 Proxy</h1>
<h2 id="quick-links">Quick Links</h2>
<ul>
<li><a href="https://oauth2-proxy.github.io/oauth2-proxy/">Project Site</a></li>
<li><a href="https://github.com/oauth2-proxy/oauth2-proxy">Github Repo</a></li>
<li><a href="https://github.com/oauth2-proxy/manifests/tree/main/helm/oauth2-proxy">Helm Chart</a></li>
</ul>
<h2 id="background">Background</h2>
<p>The Oauth2 Proxy service is integrated with NGINX Ingress to provide authentication capabilities for services running
in the cluster. The Oauth2 Proxy can be configured to integrate with a variety of different Identity Providers via ODIC.</p>
<h2 id="sandbox-customizations">Sandbox Customizations</h2>
<p>The Sandbox installation of Oauth2 Proxy includes a mostly default installation with the following modifications:</p>
<ul>
<li>Enables a virtual server for the cluster service at "auth.<your cluster domain>"</li>
<li>Leverages an existing secret for OIDC client data (deployed as part of the sandbox-apps proxy helm chart).</li>
<li>Enables authorization / token / user headers to upstream services.</li>
</ul>
<p>Values can be passed to the official oauth2-proxy chart (by adding them under the "oauth2-proxy" key),
as shown on line 4 of the values file here:</p>
<pre><code class="language-yaml">clusterDomain: example.com
enableVirtualServer: true

oauth2-proxy:
  config:
    existingSecret: oauth-proxy-creds
    configFile: |-
      upstreams=[ &quot;file:///dev/null&quot; ]
      provider=&quot;oidc&quot;
      http_address=&quot;0.0.0.0:4180&quot;
      set_xauthrequest=true
      cookie_secure=true
      skip_jwt_bearer_tokens=true
      pass_access_token=true
      pass_authorization_header=true
      pass_user_headers=true
      set_authorization_header=true
</code></pre>
<p>See <a href="../../customization/default-services/">Customizing Default Services</a> for more information on overriding default values.</p>
<h2 id="enable-a-virtual-server-for-oauth-proxy-authentication">Enable A Virtual Server For Oauth Proxy Authentication</h2>
<p>The following Grafana virtual server config illustrates the integration of NGINX ingress and Oauth2 Proxy
to authenticate users accessing services in the cluster. The Virtual Server directs traffic to either the
Grafana or Ouath2 Proxy Virtual Server Routes, depending on the state of the client.</p>
<blockquote>
<p>Note: the "{{ .Values.clusterDomain }}" field is passed to the cluster via helm in a default install.</p>
</blockquote>
<pre><code class="language-yaml">apiVersion: k8s.nginx.org/v1
kind: VirtualServer
metadata:
  name: grafana
  namespace: &quot;grafana&quot;
spec:
  host: &quot;grafana.{{ .Values.clusterDomain }}&quot;
  tls:
    cert-manager:
      cluster-issuer: letsencrypt-prod
    secret: grafana-cert
  routes:
  - path: /
    route: grafana/grafana
    location-snippets: |
      auth_request /oauth2/auth;
      error_page 401 = https://auth.{{ .Values.clusterDomain }}/oauth2/start?rd=https://$host$uri;
      auth_request_set $user   $upstream_http_x_auth_request_user;
      auth_request_set $email  $upstream_http_x_auth_request_email;
      auth_request_set $auth_header $upstream_http_authorization;
      auth_request_set $token  $upstream_http_x_auth_request_access_token;
      proxy_set_header X-Access-Token $token;
      auth_request_set $auth_cookie $upstream_http_set_cookie;
      add_header Set-Cookie $auth_cookie;
      proxy_set_header X-Auth-Request-Email &quot;$email&quot;;
      proxy_set_header X-Auth-Request-User &quot;$user&quot;;
      #proxy_set_header Authorization &quot;$auth_header&quot;;
      set $session_id_header $upstream_http_x_auth_request_email;
  - path: /oauth2
    route: oauth-proxy/oauth-proxy-grafana

---
apiVersion: k8s.nginx.org/v1
kind: VirtualServerRoute
metadata:
  name: grafana
  namespace: grafana
spec:
  host: &quot;grafana.{{ .Values.clusterDomain }}&quot;
  upstreams:
  - name: grafana
    service: grafana
    port: 80
  subroutes:
  - path: /
    action:
      pass: grafana

---
apiVersion: k8s.nginx.org/v1
kind: VirtualServerRoute
metadata:
  name: oauth-proxy-grafana
  namespace: oauth-proxy
spec:
  host: &quot;grafana.{{ .Values.clusterDomain }}&quot;
  upstreams:
  - name: oauth2-proxy
    service: oauth-proxy-oauth2-proxy
    port: 80
  subroutes:
  - path: /oauth2/auth
    location-snippets: &quot;internal;&quot;
    action:
      pass: oauth2-proxy
</code></pre>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../nginx-mesh/" class="btn btn-neutral float-left" title="NGINX Service Mesh"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../opentelemetry-operator/" class="btn btn-neutral float-right" title="Opentelemetry Operator">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../nginx-mesh/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../opentelemetry-operator/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme_extra.js" defer></script>
    <script src="../../js/theme.js" defer></script>
      <script src="../../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
